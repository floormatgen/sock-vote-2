asyncapi: 3.0.0
info:
  title: sock-vote-server
  description:
    Specifies connection information for the real time voting system.
    This uses both WebSocket as well as HTTP, where WebSocket is used for notifications,
    while HTTP is used for question and vote submissions.
  version: '0.1.0'

channels: 
  room:
    address: 'room/connect/{code}'
    description:
      Used to send change notifications to the client, such as when the topic changes.
    parameters:
      code:
        $ref: '#/components/parameters/RoomCode'
    bindings:
      ws:
        headers:
          type: object
          properties: 
            'X-participant-token':
              type: string
              description:
                The token that uniquely identifies each participant
    messages:
      receiveVote:
        $ref: '#/components/messages/receiveVote'
      replacePoll:
        $ref: '#/components/messages/replacePoll'
      removePoll:
        $ref: '#/components/messages/removePoll'
  manageRoom:
    address: 'room/manage/{code}'
    parameters:
      code:
        $ref: '#/components/parameters/RoomCode'
    bindings:
      ws:
        headers:
          type: object
          properties:
            'X-manager-token':
              type: string
              description:
                The token received after creating the room.
                Used to make sure only managers can commit to special actions like creating a ro
    messages:
      createNewPoll:
        $ref: '#/components/messages/createNewPoll'
  viewRoom:
    address: 'room/view/{code}'
    parameters:
      code:
        $ref: '#/components/parameters/RoomCode'

operations:

  # MARK: - Voting
  receiveVote:
    summary: Receive Vote
    action: receive
    channel:
      $ref: '#/channels/room'
    messages:
      - $ref: '#/channels/room/messages/receiveVote'
  updatePoll:
    summary: Update Poll
    action: send
    channel:
      $ref: '#/channels/room'
    messages:
      - $ref: '#/channels/room/messages/replacePoll'
      - $ref: '#/channels/room/messages/removePoll'
  
  # MARK: - Admin
  createNewPoll:
    action: receive
    channel:
      $ref: '#/channels/manageRoom'
    messages:
      - $ref: '#/channels/manageRoom/messages/createNewPoll'
  removePoll:
    summary: Remove Poll
    action: receive
    channel:
      $ref: '#/channels/manageRoom'

components:

  messages:
    receiveVote:
      title: Vote
      summary: When a user votes on an active poll
      payload:
        type: object
        properties: 
          type:
            const: 'vote'
          message:
            $ref: '#/components/schemas/VoteSubmission'
    createNewPoll:
      title: Create Poll
      summary: Create a new poll
      payload:
        type: object
        properties: 
          type:
            const: 'createPoll'
          message:
            $ref: '#/components/schemas/PollInfo'
    replacePoll:
      title: Replace Poll (Participants)
      summary: Tells a participant to replace the poll with a new one
      payload:
        type: object
        properties:
          type:
            const: 'updatePoll'
          message:
            $ref: '#/components/schemas/PollInfo'
    removePoll:
      title: Remove Poll (Participants)
      summary: Tells a participant to remove the current poll
      payload:
        type: object
        properties: 
          type:
            const: 'removePoll'

  schemas:

    # MARK: - Payloads
    VoteSubmission:
      type: object
      properties: 
        pollID:
          type: string
          description: The unique identifier for the current poll
    PollCreateRequest:
      type: object
      properties:
        prompt:
          type: string
          description: The question to ask for the poll
        options:
          $ref: '#/components/schemas/PollOptions'
        votingStyle:
          $ref: '#/components/schemas/VotingStyle'
    PollInfo:
      type: object
      properties: 
        pollID:
          type: string
          description: The unique identifier for the poll
        prompt:
          type: string
          description: The question to ask for the poll
        options:
          $ref: '#/components/schemas/PollOptions'
        votingStyle:
          $ref: '#/components/schemas/VotingStyle'
          
    # MARK: - Custom Types
    VotingStyle:
      enum:
        - 'plurality'
        - 'preferential'
      description: 
        How votes should be counted, and the winner chosen.

    # MARK: - Aliases
    PollOptions:
      type: array
      items:
        type: string
        description: A poll option
      description: A list of options
  
  parameters:
    RoomCode:
      description: The room code of interest
